<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" type="text/css" href="./static/css/chat.css">
  <title>Chat App</title>
</head>

<body>
  <div class="calculator">
    <div id="chatDisplay" class="display"></div>
    <div class="input-area">
      <input id="messageInput" type="text" placeholder="Type a message...">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <script>
    const chatDisplay = document.getElementById('chatDisplay');
    const messageInput = document.getElementById('messageInput');

    const scheme = (location.protocol === 'https:') ? 'wss' : 'ws';
    const ws = new WebSocket(`${scheme}://${location.host}/ws`);

    ws.addEventListener('open', () => {
      console.log('WebSocket connected');
      // tell server we're ready to receive history to avoid a race
      ws.send(JSON.stringify({ type: 'ready' }));
    });

    ws.addEventListener('message', (ev) => {
      try {
        const data = JSON.parse(ev.data);
        if (data.type === 'history' && Array.isArray(data.posts)) {
          data.posts.forEach(appendMessage);
        } else if (data.type === 'message' && data.post) {
          appendMessage(data.post);
        }
        chatDisplay.scrollTop = chatDisplay.scrollHeight;
      } catch (err) {
        console.error('Invalid ws message', err);
      }
    });

    function appendMessage(m) {
      const div = document.createElement('div');
      if (m.author === 'J') {
        div.innerHTML = `<b style="color: #8A0082">${m.author}:</b> ${m.message}`;
      } else if (m.author === 'A') {
        div.innerHTML = `<b style="color: gold">${m.author}:</b> ${m.message}`;
      } else {
        div.innerHTML = `<b>${m.author}:</b> ${m.message}`;
      }
      chatDisplay.appendChild(div);
    }

    function sendMessage() {
      const text = messageInput.value.trim();
      const isIphone = /iPhone/i.test(navigator.userAgent);
      const user = isIphone ? 'J' : 'A';

      if (!text || ws.readyState !== WebSocket.OPEN) return;

      ws.send(JSON.stringify({ user, text }));
      messageInput.value = '';
    }

    let inactivityTimer;

    function resetTimer() {
      clearTimeout(inactivityTimer);
      inactivityTimer = setTimeout(() => {
        window.location.href = '/';
      }, 30000); // 30 seconds
    }

    // reset on any interaction
    ['mousemove', 'keydown', 'scroll', 'touchstart'].forEach(evt => {
      document.addEventListener(evt, resetTimer);
    });

    resetTimer(); // start timer

  </script>
</body>

</html>